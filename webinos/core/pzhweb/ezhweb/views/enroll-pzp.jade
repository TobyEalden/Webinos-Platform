extends layout

block content
  script(type='text/javascript')
    var channel;
    try {
      channel = new window.WebSocket("ws://#{pzpHost}:#{pzpPort}");
    } catch (err) {
      throw new Error ("Your browser does not support websockets. Please report your browser on webinos.org.");
    }
    channel.onerror = function (error) {
      console.error ("Connection Error: " + error.toString ());
    }
    channel.onclose = function () {
      console.log ("Zone Connection Closed");
    }
    channel.onmessage = function (message) {
      var data = JSON.parse (message.data);
      if (data.payload && data.payload.status === "csrAuthCodeByPzp") {
        //respond back to the Zone
        var req = new XMLHttpRequest ();
        req.onreadystatechange = function() {
          if (req.readyState === 4) {
            var msg = req.responseText;
            if (msg !== "") {
              var parse = JSON.parse(msg);
              channel.send(JSON.stringify(parse.message));
              window.location.href = "http://#{pzpHost}:#{pzpPort}/testbed/client.html";
              channel.close();
            }
          }
        }
        req.open("POST", window.location.protocol + "//" + window.location.host + "/main/#{user}/pzpEnroll/");
        req.setRequestHeader ("Content-Type", "application/json");
        req.send(JSON.stringify({authCode:data.payload.authCode, csr:data.payload.csr, from:data.from}));
      }
    }
    channel.onopen = function() {
      console.log("connection successful");
      var data = {type:"prop", from: window.location.host+"_#{user}" , to: "",
        payload:{
          status:"authCodeByPzh",
          authCode:"#{authCode}",
          providerDetails:((#{port} !== 443) ? ("#{address}:#{port}") : "#{address}")}};
      channel.send(JSON.stringify(data));
    }
  div(data-role='content')
    img(src='/images/logo.png', style='float:left;padding-right:10px;')
    h1 UbiApps Enterprise Zone
    h3(style="clear:both;")  Your device is being enrolled at the Zone.
    p Please hold - you will redirected automatically...
